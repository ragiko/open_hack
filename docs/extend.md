
## 独自に用意した拡張機能

GroupWorkBase は Slim をベースに構築していますが、ある程度使いやすくするために以下のような拡張を既に行なっています。
これらは Slim には無い機能です。

### サービスコンテナ

アプリケーションの色々なサービス(ライブラリ)はお互いに依存していることが多くあります。
たとえば、

- `テンプレートエンジン`は、どこに`テンプレートファイル`があるかを教える必要がある
- `ユーザーモデル`は、`データベース`からデータを取ってこないといけない
- `テンプレート`の中で`セッション`の情報を使いたい

これらを依存関係をPimpleというサービスコンテナに閉じ込めて、コンテナ経由で値の取得やデータのやりとりを行なっています。

コードの中では `$container` という名前の変数がPimple(サービスコンテナ)になります。
Pimpleでは無名関数を利用することで、定義した時点ではなく、実際に呼び出されたときに依存関係を解決しようとします。
そのため、定義の順序は前後してもアプリケーションの動作には影響がないのが特徴です。

GroupWorkBase では 設定項目は `src/config.php` に、ライブラリの定義は `src/bootstrap.php` で行なっています。

### データベースへのアクセス

PHP標準の PDO クラスをラップした `src/Vg/Database` クラスを利用しています。
SQLの書き方、その発行の仕方は サンプルアプリと PHPの PDO マニュアルを参考にしてみてください。
`$container['db']`で呼び出せます。

### セッション

Slim にはセッションを簡単にあつかうための仕組みがありません。GroupWorkBase では `src/Vg/Session.php` を用意しこのクラスを利用してセッションを呼び出します。
`$container['session']`で呼び出せます。

### テンプレート内で利用できる機能

通常のTwigの機能に以下の便利機能を拡張しています。

- `debug()` ... PHPの`debug_print_backtrace` の実行結果を表示します。デバッグで利用すると便利です。demo画面で実際にどのように表示されるか確認できます。
- `session.get('key')` ... Sessionクラスにアクセスできます。`get('key')` でセッションの値にアクセスできます
- `urlFor('ルーティングの名前')` ... SlimのurlForメソッドをテンプレートで呼び出せるようにしています。ルーティングにnameメソッドで付けた名前のURLを解決しパスを生成します。パスが変更になってもテンプレートの修正は不要になります。
- `asset('js,cssのパス')` ... jsやcssのパスを指定します。アプリケーションのドキュメントルートが変更になっても自動的に解決してくれます。

### モデルとリポジトリ

Railsでよく利用される ActiveRecord と異なります。いわゆるRepositoryパターンです。
ひとことでまとめると以下の分類です。

- ロジックを担当 ... モデル
- データベースとやりとりを担当 ... リポジトリ

サンプルは `src/bootstrap.php` に定義している `$container['repository.user']` の実態である `src/Vg/Repository/UserRepository.php` とそのモデルである `src/Vg/Model/User.php` を見てみてください。

Userモデルは名前、メールアドレス...などのプロパティを持っていて、どのようにパスワードを暗号化するかを把握しています。

Userリポジトリは、Userモデルをデータベースに保存したり、IDでデータベースからデータを取得したりとデータベースとの会話を担当しています。

もし、ユーザーを作成する場合は、

- 新しいUserクラスを作成
- Userリポジトリのinsertメソッドに Userを渡して保存してもらう

もし、ユーザーを取得する場合は

- Userリポジトリに取得したユーザーのIDを渡す
- Userリポジトリはデータベースからユーザー情報を取得し、Userクラスを作成して返却する

このようなお互いの関係になっています。つまり、永続化層がモデルときちんと分離されているため `1テーブル = 1モデル` のような制約はありません。

### バリデータ

入力値のチェックのような値の妥当性を行うのがバリデータです。Slimには標準でバリデータは含まれていません。
GroupWorkBase では Symfony Component というWebアプリケーション構築で利用できるライブラリから Validator Component を単独で利用しています。
具体的な利用例は `/src/app/user.php` を見てみてください。

